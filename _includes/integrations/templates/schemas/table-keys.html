<!-- This file includes the logic used to get table primary keys
    and replication keys.
    USED IN: _includes/integrations/templates/schemas/table-snapshot.html -->

{% case include.key %}

    {% when 'primary-key' %}
        <!-- Some tables can have composite keys, or multiple columns that make up a PK. 
             Jekyll tends to add a lot of ugly white space to lists of Liquid variables, so 
             to get this to display nicely in the table snapshot, we have to:

             1. Run a forloop that captures the names of all attributes marked as PKs and save it as clean-keys,
             2. Append ":" to each attribute name (for visual separation),
             3. Split the clean-keys array, reverse it, join it, and then remove the first ":" (this is because Liquid doesn't have a remove_last filter) and save it as reverse-pk-keys
             4. Split the reverse-pk-keys array, reverse it, and join it again -->

        <!-- Captures & cleans field names for PKs -->
            {% assign primary-keys = table.attributes | where:"primary-key",true %}

            {% assign primary-key-length = primary-keys.size %}

            {% if primary-key-length == 0 %}
                {% capture primary-keys %}
                    None
                {% endcapture %}

            {% else %}
                {% capture clean-keys %}
                    {% for key in primary-keys %}{{ key.name | flatify | append: " :" }}
                    {% endfor %}
                {% endcapture %}

                {% capture reverse-pk-keys %}
                    {{ clean-keys | split: "" | reverse | join: "" | remove_first: ": " }}
                {% endcapture %}

                {% capture primary-keys %}
                    {{ reverse-pk-keys | split: "" | reverse | join: "" }}
                {% endcapture %}
                
            {% endif %}

        <!-- End PKs -->


    {% when 'replication-key' %}

        <!-- Captures Replication Key fields -->
        <!-- The process here is the same as the one for Primary Keys, but
            1. Only runs if the table is marked as "Incremental"
            2. Captures attributes marked as Replication Keys -->

            <!-- Sometimes Stitch uses query parameters to incrementally replicate
            data. Since this isn't actually a field, it won't be in the table.attributes
            list - it gets its own Frontmatter variable (table.replication-key).
             -->
                {% if table.replication-key.name %}
                    {% assign replication-keys = table.replication-key.name %}
                    {% assign replication-tooltip = table.replication-key.tooltip %}

                {% else %}

                    {% capture clean-replication-keys %}
                        {% for attribute in table.attributes %}{% if attribute.replication-key == true %}{{ attribute.name | flatify | append: " :" }}{% endif %}
                        {% endfor %}
                    {% endcapture %}

                    {% capture reverse-rk-keys %}
                        {{ clean-replication-keys | split: "" | reverse | join: "" | remove_first: ": " }}
                    {% endcapture %}

                    {% capture replication-keys %}
                        {{ reverse-rk-keys | split: "" | reverse | join: "" }}
                    {% endcapture %}
                {% endif %}
        <!-- End Replication Key -->
{% endcase %}